<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>TestReport</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1428037674000</creationDate>
  <parent>PhenoTips.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1428038543000</date>
  <contentUpdateDate>1428038536000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{groovy}}
import com.xpn.xwiki.doc.XWikiDocument;
//we don't want to inject mappings every time you view the page.
//nor do we want non-admin users running this script
if(xcontext.getRequest().get("injectMapping")!=null
  &amp;&amp; xwiki.hasAdminRights()){
   //get some objects.
   xc = xcontext.getContext();
    wiki = xc.getWiki();
    thisClass = doc.getDocument().getXClass()
   //set the mapping
   thisClass.setCustomMapping(
"&lt;property name=\"patientId\" type=\"string\" column=\"PATIENTID\" length=\"255\" /&gt;"+
"&lt;property name=\"filepath\" type=\"string\" column=\"filepath\" /&gt;"+
"&lt;property name=\"date\" type=\"long\" column=\"date\" /&gt;"+
"&lt;property name=\"columnCount\" type=\"integer\" column=\"column_count\" /&gt;"+
"&lt;list name=\"columnOrder\" table=\"testreport_columnorder\"&gt;"+
"&lt;key column=\"qid\"/&gt;"+
"&lt;list-index column=\"list_order\"/&gt;"+
"&lt;element column=\"column_order\" type=\"string\"/&gt;"+
"&lt;/list&gt;"+
"&lt;list name=\"data\" table=\"testreport_data\"&gt;"+
"&lt;key column=\"qid\"/&gt;"+
"&lt;list-index column=\"data_order\"/&gt;"+
"&lt;element column=\"data\" type=\"string\"/&gt;"+
"&lt;/list&gt;"
   );

   //XWiki provides us with a way to test our custom mapping!
   if(thisClass.isCustomMappingValid(xc)){
       //We must save the document with the new custom mapping set.
       doc.save();
       //This will make Hibernate create the new database table.
       wiki.getHibernateStore().updateSchema(thisClass, xc);
        println("Done :)");
   }else{
        println("The mapping is not valid, consult your error log to find the problem.")
   }
}else{
    println("To inject custom mapping for this class, click [[here&gt;&gt;"+
            doc.getFullName()+"?injectMapping]]");
}
{{/groovy}}</content>
  <class>
    <name>PhenoTips.TestReport</name>
    <customClass/>
    <customMapping>&lt;property name="patientId" type="string" column="PATIENTID" length="255" /&gt;&lt;property name="filepath" type="string" column="filepath" /&gt;&lt;property name="date" type="long" column="date" /&gt;&lt;property name="columnCount" type="integer" column="column_count" /&gt;&lt;list name="columnOrder" table="testreport_columnorder"&gt;&lt;key column="qid"/&gt;&lt;list-index column="list_order"/&gt;&lt;element column="column_order" type="string"/&gt;&lt;/list&gt;&lt;list name="data" table="testreport_data"&gt;&lt;key column="qid"/&gt;&lt;list-index column="data_order"/&gt;&lt;element column="data" type="string"/&gt;&lt;/list&gt;</customMapping>
    <defaultViewSheet/>
    <defaultEditSheet/>
    <defaultWeb/>
    <nameField/>
    <validationScript/>
    <columnCount>
      <customDisplay/>
      <disabled>0</disabled>
      <name>columnCount</name>
      <number>4</number>
      <numberType>integer</numberType>
      <prettyName>columnCount</prettyName>
      <size>30</size>
      <unmodifiable>0</unmodifiable>
      <validationMessage/>
      <validationRegExp/>
      <classType>com.xpn.xwiki.objects.classes.NumberClass</classType>
    </columnCount>
    <columnOrder>
      <cache>0</cache>
      <classname/>
      <customDisplay/>
      <disabled>0</disabled>
      <displayType>select</displayType>
      <idField/>
      <multiSelect>1</multiSelect>
      <name>columnOrder</name>
      <number>5</number>
      <picker>0</picker>
      <prettyName>columnOrder</prettyName>
      <relationalStorage>1</relationalStorage>
      <separator> </separator>
      <separators/>
      <size>1</size>
      <sort>none</sort>
      <sql/>
      <unmodifiable>0</unmodifiable>
      <validationMessage/>
      <validationRegExp/>
      <valueField/>
      <classType>com.xpn.xwiki.objects.classes.DBListClass</classType>
    </columnOrder>
    <data>
      <cache>0</cache>
      <classname/>
      <customDisplay/>
      <disabled>0</disabled>
      <displayType>select</displayType>
      <idField/>
      <multiSelect>1</multiSelect>
      <name>data</name>
      <number>6</number>
      <picker>0</picker>
      <prettyName>data</prettyName>
      <relationalStorage>1</relationalStorage>
      <separator> </separator>
      <separators/>
      <size>1</size>
      <sort>none</sort>
      <sql/>
      <unmodifiable>0</unmodifiable>
      <validationMessage/>
      <validationRegExp/>
      <valueField/>
      <classType>com.xpn.xwiki.objects.classes.DBListClass</classType>
    </data>
    <date>
      <customDisplay/>
      <disabled>0</disabled>
      <name>date</name>
      <number>3</number>
      <numberType>long</numberType>
      <prettyName>date</prettyName>
      <size>30</size>
      <unmodifiable>0</unmodifiable>
      <validationMessage/>
      <validationRegExp/>
      <classType>com.xpn.xwiki.objects.classes.NumberClass</classType>
    </date>
    <filepath>
      <customDisplay/>
      <disabled>0</disabled>
      <name>filepath</name>
      <number>2</number>
      <picker>0</picker>
      <prettyName>filepath</prettyName>
      <size>30</size>
      <unmodifiable>0</unmodifiable>
      <validationMessage/>
      <validationRegExp/>
      <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
    </filepath>
    <patientId>
      <customDisplay/>
      <disabled>0</disabled>
      <name>patientId</name>
      <number>1</number>
      <picker>0</picker>
      <prettyName>patientId</prettyName>
      <size>30</size>
      <unmodifiable>0</unmodifiable>
      <validationMessage/>
      <validationRegExp/>
      <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
    </patientId>
  </class>
</xwikidoc>
