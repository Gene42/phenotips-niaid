
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>pt-22</title>
	<style>
		.measurement {
			padding: 0.2em 0;
			clear: both;
		}
		.measurement > * {
			float: left;
		}
		.measurement .delete {
			width: 15px;
			cursor: pointer;
			font-size: 80%;
			font-weight: bold;
		}
		.measurement-row > * {
			display: block;
			float: left;
			min-height: 1px;
		}
		.measurement-row span.side-label {
			width: 15px;
			font-size: 80%;
			font-weight: bold;
		}
		.measurement-row span.unit {
			width: 25px;
		}
		.measurement-row span.pctl {
			width: 100px;
			font-size: 80%;
		}
		.measurement-row label {
			width: 180px;
		}
		.pctl.sd-0 { color: green; }
		.pctl.sd-1 { color: orange; }
		.pctl.sd-2 { color: red; }
		.measurement-set.proto {
			display: none;
		}
		.measurement-set {
			border: 1px solid #aaa;
			padding: 10px;
			float: left;
			clear: both;
			overflow: auto;
			margin: 5px;
			position: relative;
		}
		.measurement-set > .delete {
			width: 15px;
			font-size: 80%;
			font-weight: bold;
			cursor: pointer;
			position: absolute;
			top: 10px; right: 10px;
		}
		.new-measurement-select {
			width: 190px;
		}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
	<script>
		var measurements = [
			{
				name: "Weight",
				isTwoSided: false,
				isComputed: false,
				unit: "kg",
			},
			{
				name: "Height",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Arm Span",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Head Circumference",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Outer Canthal Distance",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Inner Canthal Distance",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Hand Length",
				isTwoSided: true,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Palm Length",
				isTwoSided: true,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Foot Length",
				isTwoSided: true,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Sitting Height",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "BMI",
				isTwoSided: false,
				isComputed: true,
				unit: "kg/m^2",
				computationDep: ["Weight", "Height"]
			},
			{
				name: "Philtrum Length",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Ear Length",
				isTwoSided: true,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Palpebral Fissure Length",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Interpupilary Distance",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Middle Finger Length",
				isTwoSided: true,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Internipple Distance",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Chest Circumference",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Internipple Index",
				isTwoSided: false,
				isComputed: true,
				unit: null,
				computationDep: ["Internipple Distance", "Chest Circumference"],
			},
			{
				name: "Upper Segment",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "Lower Segment",
				isTwoSided: false,
				isComputed: false,
				unit: "cm",
			},
			{
				name: "US:LS Ratio",
				isTwoSided: false,
				isComputed: true,
				unit: null,
				computationDep: ["Upper Segment", "Lower Segment"],
			},
		];

		var defaultMeasurements = [
			"Weight", "Height", "BMI", "Head Circumference"
		];

		/*
		measurement: {

		}
		*/
		var addMeasurementRow = function(measurementRow) {
			var container = new Element('div').addClassName('measurement-row');

			var label = new Element('label');
			label.innerHTML = measurementRow.name;

			var sideLabel = new Element('span').addClassName('side-label');
			if (measurementRow.side) {
				sideLabel.innerHTML = measurementRow.side;
			}

			var input = new Element('input');
			input.type = "text";
			input.size = 6;
			if (measurementRow.isReadOnly) {
				input.readOnly = true;
			}
			input.observe('input', measurementInputHandler);

			var unit = new Element('span').addClassName('unit');
			unit.innerHTML = measurementRow.unit;

			var pctl = new Element('span').addClassName('pctl');

			container.insert(label);
			container.insert(sideLabel);
			container.insert(input);
			container.insert(unit);
			container.insert(pctl);
			this.insert(container);
		};

		var addMeasurement = function(measurement) {
			var container = new Element('div').addClassName('measurement');

			var deleteButton = new Element('span').addClassName('delete');
			deleteButton.innerHTML = '&times;';
			deleteButton.observe('click', function() {
				this.up().remove();
			});
			container.insert(deleteButton);

			if (measurement.computationDep && measurement.computationDep.length) {
				for (var i = 0; i < measurement.computationDep.length; i++) {
					addMeasurement.apply(this, [getMeasurementByName(measurement.computationDep[i])]);
				}
			}

			if (measurement.isTwoSided) {
				addMeasurementRow.apply(container, [{
					name: measurement.name,
					unit: measurement.unit,
					side: 'R',
				}]);
				addMeasurementRow.apply(container, [{
					name: '',
					unit: measurement.unit,
					side: 'L',
				}]);
			} else {
				var row = Object.clone(measurement);
				row.isReadOnly = measurement.isComputed;
				addMeasurementRow.apply(container, [row]);
			}

			this.insert(container);

			var opts = this.up().select('.new-measurement-select')[0].options;
			for (var i = 0; i < opts.length; i++) {
				if (opts[i].value == measurement.name) {
					opts[i].remove();
				}
			}
		};

		var addDefaults = function() {
			for (var i = 0; i < defaultMeasurements.length; i++) {
				addMeasurement.apply(this, [measurements[i]]);
			}
		};

		var getMeasurementByName = function(name) {
			for (var i = 0; i < measurements.length; i++) {
				if (measurements[i].name == name) {
					return measurements[i];
				}
			}

			return null;
		};

		var addMeasurementHandler = function() {
			var selection = this.up().select('.new-measurement-select')[0];
			var selectionName = selection.selectedIndex >= 0 ? selection.options[selection.selectedIndex].innerHTML : undefined;

			addMeasurement.apply(this.up().select('.measurements')[0], [getMeasurementByName(selectionName)]);
		};

		var addMeasurementSet = function() {
			var clone = $$('.measurement-set.proto')[0].clone(true);
			clone.removeClassName('proto');
			clone.select('.btn_add-measurement')[0].observe('click', addMeasurementHandler);
			clone.select('.date')[0].observe('input', dateChangeHandler);
			clone.select('> .delete')[0].observe('click', function() {
				this.up().remove();
			});
			$('measurements').insert(clone);
			return clone;
		};

		var handleAddMeasurementSet = function() {
			$$('.btn_add-measurement-set')[0].observe('click', function() {
				addDefaults.apply(addMeasurementSet().select('.measurements')[0]);
			});
		};

		var measurementInputHandler = function() {
			if (parseInt(this.value) > 1) {
				var className = 'sd-0';
				var pctlText = '50th pctl (0SD)';
			} else {
				var className = 'sd-1';
				var pctlText = '25th pctl (1SD)';
			}

			var pctl = this.up().select('.pctl')[0];
			pctl.removeClassName('sd-0').removeClassName('sd-1').removeClassName('sd-2');
			pctl.addClassName(className);
			pctl.innerText = pctlText;
		};

		var dateChangeHandler = function() {
			if (!this.value || !$('bday').value) return;

			var bday = moment($('bday').value);
			var ageYears = moment().diff(bday, 'years');
			this.up().select('input.years')[0].value = ageYears;
			this.up().select('input.months')[0].value = moment().diff(bday, 'months') - ageYears*12;
		};

		var init = function() {
			handleAddMeasurementSet();
			addMeasurementSet();
			addDefaults.apply($$('.measurement-set:not(.proto) .measurements')[0]);
		};
	</script>
</head>
<body>
	<label>Birthdate:</label> 
	<input type="date" id="bday">
	<div id="measurements">
		<div class="measurement-set proto">
			<span class="delete">&times;</span>
			<label for="date">Date:</label> <input class="date" type="date">
			<label for="">Age:</label> <input type="text" size="2" class="years">y <input type="text" size="2" class="months">m

			<div class="measurements">
				
			</div>

			<select class="new-measurement-select">
				<option>Weight</option>
				<option>Height</option>
				<option>Arm Span</option>
				<option>Head Circumference</option>
				<option>Outer Canthal Distance</option>
				<option>Inner Canthal Distance</option>
				<option>Hand Length</option>
				<option>Palm Length</option>
				<option>Foot Length</option>
				<option>Sitting Height</option>
				<option>BMI</option>
				<option>Philtrum Length</option>
				<option>Ear Length</option>
				<option>Palpebral Fissure Length</option>
				<option>Interpupilary Distance</option>
				<option>Middle Finger Length</option>
				<option>Internipple Distance</option>
				<option>Chest Circumference</option>
				<option>Internipple Index</option>
				<option>Upper Segment</option>
				<option>Lower Segment</option>
				<option>US:LS Ratio</option>
			</select>
			<button class="btn_add-measurement">Add</button>		
		</div>
	</div>

	<p style="clear: both;">
		<button class="btn_add-measurement-set">Add measurement set</button>
	</p>

	<script>
		init();
	</script>
</body>
</html>