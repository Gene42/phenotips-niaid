<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>Projects</web>
  <name>SaveProjectHandler</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1443127461000</creationDate>
  <parent>Main.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1443648267000</date>
  <contentUpdateDate>1443648267000</contentUpdateDate>
  <version>1.1</version>
  <title>SaveProjectHandler</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity wwiki="false"}}
{{html wiki="false" clean="false"}}
#set ($_service = $services.projects)
#set ($discard = $response.setContentType('application/json'))
#set ($project = $_service.getProjectById($request.projectId))
#if ("$!{request.xaction}" == 'get')
  #set ($data = {})
  #set ($contributors = [])
  #set ($leaders = [])
  #set ($templates = [])
  ##
  #if ($project)
    #set ($rawCollaborators = $project.getCollaborators())
    ##
    ## Format collaborators for UI side
    #foreach ($c in $rawCollaborators)
      #set ($collaborator = {})
      #set ($discard = $collaborator.put('id', $c.user.toString()))
      #set ($discard = $collaborator.put('type', $c.type))
      #if ($c.type == 'user')
        #set ($discard = $collaborator.put('name', $xwiki.getUserName("${c.user}", false)))
      #else
        #set ($discard = $collaborator.put('name', "$!{xwiki.getDocument($c.user).plainTitle}"))
      #end
      #if ($c.accessLevel.name == "leader")
        #set ($discard = $leaders.add($collaborator))
      #else
        #set ($discard = $contributors.add($collaborator))
      #end
    #end
    ##
    #set ($rawTempaltes = $project.getTemplates())
      #foreach ($t in $rawTempaltes)
      #set ($template = {})
      #set ($discard = $template.put('id', $t.id))
      #set ($discard = $template.put('value', $t.name))
      #set ($discard = $templates.add($template))
    #end
  #end
  #set ($discard = $data.put('contributors', $contributors))
  #set ($discard = $data.put('leaders', $leaders))
  #set ($discard = $data.put('templates', $templates))
  ##
  $jsontool.serialize($data)
#elseif ("$!{request.xaction}" == 'update')
  #set ($contributorsStrings = $request.getParameterValues('contributors'))
  #set ($leadersString = $request.getParameterValues('leaders'))
  #set ($templatesString = $request.getParameterValues('templates'))
  ##
  #set ($contributors = [])
  #foreach ($contributor in $contributorsStrings)
    #set ($discard = $contributors.add($services.model.resolveDocument($contributor)))
  #end
  #set ($leaders = [])
  #foreach ($leader in $leadersString)
    #set ($discard = $leaders.add($services.model.resolveDocument($leader)))
  #end
  #set ($discard = $project.setCollaborators($contributors, $leaders))
  ##
  #set ($templates = [])
  #foreach ($template in $templatesString)
    #set ($discard = $templates.add($services.model.resolveDocument($template)))
  #end
  #set ($discard = $project.setTemplates($templates))
#end
{{/velocity}}</content>
</xwikidoc>
