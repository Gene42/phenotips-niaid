<?xml version="1.0" encoding="UTF-8"?>

<!--
 * This file is subject to the terms and conditions defined in file LICENSE,
 * which is part of this source code package.
 *
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>UIX_Field__gene-variants</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1401822202000</creationDate>
  <parent>PhenoTips.PatientSheet</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1475011747000</date>
  <contentUpdateDate>1474912978000</contentUpdateDate>
  <version>1.1</version>
  <title>$services.localization.render('phenotips.UIXField.genes')</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content/>
  <object>
    <name>PhenoTips.UIX_Field__gene-variants</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>b46a25fc-dce7-42a5-b65b-61fb4d620449</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>var ModifiedGeneTable = (function (ModifiedGeneTable) {
  var tools = ModifiedGeneTable.tools = ModifiedGeneTable.tools || {};
  tools.Editor = Class.create({
    initialize : function (element) {
      this.element = element;

      if (this.element.hasClassName('gene-table')) {
        this._geneTable = this.element;
        this._statusHeader = this._geneTable.down('.gene-t-header-status');
        this._strategyHeader = this._geneTable.down('.gene-t-header-strategy');
        this._statusCol = this._geneTable.select('.Status.gene');
        this._strategyCol = this._geneTable.select('.Strategy.gene');
        this._expandIcon = new Element('i', {'class': 'fa fa-ellipsis-h fa-2 expand-icon', 'aria-hidden': 'true'});
      	this._collapseIcon = new Element('i', {'class': 'fa fa-minus-square-o fa-lg collapse-icon', 'aria-hidden': 'true'});
        this._geneTableToggleButton = new Element('span', {'class': 'buttonwrapper'})
        	.insert(new Element('button', {'type': 'button', 'class': 'property-hideTool collapsed tool button secondary'})
        	.insert(this._expandIcon).insert(this._collapseIcon));
        this._initializeModifiedGeneTable();
        this._statusHeader.observe("click", this._toggleHiddenGeneProperties.bind(this));
        this._addGeneButton = this.element.up().down('.list-actions a.add-gene');
        if (this._addGeneButton) {
          this._addGeneButton.observe("click", this._handleDisplayLastGeneEntry.bind(this))
        }
      } else if (this.element.hasClassName('property-hideTool')) {
        this._hideTool = this.element;
        this._hideTool.observe("click", this._toggleHiddenGeneVariantProperties.bind(this));
      } else if (this.element.hasClassName('cliaConfirmed')) {
        this._cliaConfirmation = this.element;
        this._cliaConfirmation.observe("click", this._toggleCliaReportCheckbox.bind(this));
      } else if (this.element.hasClassName('add-variant')) {
        this._addGeneVariantButton = this.element;
        this._addGeneVariantButton.observe("click", this._handleDisplayLastGeneVariantEntry.bind(this));
      }

      this.element.__self = this;
    },
    _initializeModifiedGeneTable: function() {
    	this._statusHeader.update('');  
    	this._strategyHeader.update('');
    	this._collapseIcon.style.display = "none"
    	this._statusHeader.insert(this._geneTableToggleButton);
      this._statusHeader.addClassName('collapsed');

      var l = this._strategyCol.length;
      for (var i = 0; i &lt; l; i++) {
        this._strategyCol[i].style.visibility = "hidden"; 
        this._statusCol[i].style.visibility = "hidden";
      }
    },
    _handleDisplayLastGeneEntry: function() { 
      this._strategyCol = this._geneTable.select('.Strategy.gene');
      this._statusCol = this._geneTable.select('.Status.gene');

      if (this._geneTable.down('tr.variant-footer:last-of-type')) {
        var lastAdded = this._geneTable.down('tr.variant-footer:last-of-type').previous();
        var status = lastAdded.down('.Status.gene');
        var strategy = lastAdded.down('.Strategy.gene'); 
      }

      if (lastAdded &amp;&amp; this._statusHeader.hasClassName('collapsed')) {
        status.style.visibility = "hidden"; 
        strategy.style.visibility = "hidden"; 
      } else {
        status.style.visibility = ""; 
        strategy.style.visibility = "";
      }
      Event.fire(document, 'xwiki:dom:updated', {elements :[this._geneTable]});
    },
    _toggleHiddenGeneProperties: function() {
      var visibilityCondition; 
      if (this._statusHeader.hasClassName('collapsed')) {
        this._statusHeader.removeClassName('collapsed');
        this._statusHeader.update('Status');
        this._strategyHeader.update('Strategy');
        this._statusHeader.insertBefore(this._geneTableToggleButton, this._statusHeader.childNodes[0]);
        this._collapseIcon.style.display = ""; 
        this._expandIcon.style.display = "none";
        visibilityCondition = ""
      } else {
        this._statusHeader.addClassName('collapsed');
	    	this._statusHeader.update('');  
	    	this._strategyHeader.update('');  
	    	this._statusHeader.insert(this._geneTableToggleButton);
	    	this._collapseIcon.style.display = "none"; 
	    	this._expandIcon.style.display = "";
        visibilityCondition = "hidden"
      }
      var l = this._strategyCol.length;
      for (var i = 0; i &lt; l; i++) {
        this._strategyCol[i].style.visibility = visibilityCondition; 
        this._statusCol[i].style.visibility = visibilityCondition;
      }
    },
    _toggleHiddenGeneVariantProperties: function() {
      var currVariantTable = this._hideTool.up('div.variant-moreinfo-editbutton-row');
      if (currVariantTable &amp;&amp; this._hideTool.hasClassName('collapsed')) {
        currVariantTable.select('.hiddenVariantProperty').each(function(item) {
          item.style.visibility = ""; 
        })
        this._hideTool.down('i.fa.expand-icon').style.display = "none";
        this._hideTool.down('i.fa.collapse-icon').style.display = "";
        this._hideTool.removeClassName('collapsed');
      } else if (currVariantTable) {
        currVariantTable.select('.hiddenVariantProperty').each(function(item) {
          item.style.visibility = "hidden"; 
        })
        this._hideTool.down('i.fa.expand-icon').style.display = "";
        this._hideTool.down('i.fa.collapse-icon').style.display = "none"; 
        this._hideTool.addClassName('collapsed');
      }
    },
    _toggleCliaReportCheckbox: function() {
      var currVariantTable = this._cliaConfirmation.up('div.variant-moreinfo-editbutton-row'); 
      var checkbox = this._cliaConfirmation.down('input');

      if (currVariantTable &amp;&amp; checkbox &amp;&amp; checkbox.type == "checkbox") {
        if (checkbox.checked &amp;&amp; this._cliaConfirmation.hasClassName('collapsed')) {
          checkbox.value = 1;
          currVariantTable.select('.cliaReportProperty').each(function(item) {
            item.style.display = ""; 
          })
          this._cliaConfirmation.down('.show-moreinfo-button.triDown').style.display = ""; 
          this._cliaConfirmation.down('.show-moreinfo-button.triRight').style.display = "none";
          this._cliaConfirmation.removeClassName('collapsed');
        } else if (!checkbox.checked &amp;&amp; !this._cliaConfirmation.hasClassName('collapsed')) {
          checkbox.value = 0;
          currVariantTable.select('.cliaReportProperty').each(function(item) {
            item.style.display = "none"; 
          })
          this._cliaConfirmation.down('.show-moreinfo-button.triRight').style.display = ""; 
          this._cliaConfirmation.down('.show-moreinfo-button.triDown').style.display = "none";
          this._cliaConfirmation.addClassName('collapsed');
        }
      }
    },
    _handleDisplayLastGeneVariantEntry: function(event) { 
      event.stop();
      var addButton = event.element();
      Event.fire(document, 'xwiki:dom:updated', {elements :[addButton.up('.variant-footer').previous('.variant-moreinfo-row')]});
    }
  });

  var init = function(event) {
    ((event &amp;&amp; event.memo.elements) || [$('body')]).each(function(element) {
      element.select('.gene-table').each(function(item) {
        if (!item.__self) {
          item.__self = new ModifiedGeneTable.tools.Editor(item);
        }
      });
      element.select('.property-hideTool').each(function(item) {
        if (!item.__self) {
          item.__self = new ModifiedGeneTable.tools.Editor(item);
        }
      });
      element.select('.cliaConfirmed').each(function(item) {
        if (!item.__self) {
          item.__self = new ModifiedGeneTable.tools.Editor(item);
        }
      });
      element.select('a.button.add-variant').each(function(item) {
        if (!item.__self) {
          item.__self = new ModifiedGeneTable.tools.Editor(item);
        }
      });
    });
    return true;
  };

  (XWiki.domIsLoaded &amp;&amp; init()) || document.observe("xwiki:dom:loaded", init);
  document.observe("xwiki:dom:updated", init);

  return ModifiedGeneTable;
}(ModifiedGeneTable || {}));
</code>
    </property>
    <property>
      <name>Modified gene and gene variant table displays</name>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>currentPage</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.UIX_Field__gene-variants</name>
    <number>0</number>
    <className>XWiki.UIExtensionClass</className>
    <guid>37600d90-5a22-479d-ac6e-100fe18c8696</guid>
    <class>
      <name>XWiki.UIExtensionClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <content>
        <disabled>0</disabled>
        <name>content</name>
        <number>3</number>
        <prettyName>Extension Content</prettyName>
        <rows>10</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </content>
      <extensionPointId>
        <disabled>0</disabled>
        <name>extensionPointId</name>
        <number>1</number>
        <prettyName>Extension Point ID</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </extensionPointId>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Extension ID</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parameters>
        <disabled>0</disabled>
        <name>parameters</name>
        <number>4</number>
        <prettyName>Extension Parameters</prettyName>
        <rows>10</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </parameters>
      <scope>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>scope</name>
        <number>5</number>
        <prettyName>Extension Scope</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>wiki=Current Wiki|user=Current User|global=Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </scope>
    </class>
    <property>
      <content>{{include reference="PhenoTips.PatientSheetMacros" /}}

{{include reference="PhenoTips.GeneVariantMacros" /}}

{{include reference="PhenoTips.TabelarDataMacros" /}}

{{velocity}}
$xwiki.jsx.use('PhenoTips.UIX_Field__genes')##
$xwiki.jsfx.use('uicomponents/widgets/extraGeneVariantData.js', true)##
$xwiki.jsfx.use('uicomponents/widgets/geneValidation.js', true)##
$xwiki.jsfx.use('uicomponents/widgets/variantValidation.js', true)##
$xwiki.ssfx.use('uicomponents/widgets/extraGeneVariantData.css', true)##
$xwiki.jsx.use('PhenoTips.UIX_Field__gene-variants')##
#set ($geneClassName = 'PhenoTips.GeneClass')
#set ($variantClassName = 'PhenoTips.GeneVariantClass')
#if ($xcontext.action == 'edit' || $doc.getObject($geneClassName))
=== $services.localization.render('phenotips.UIXField.genes')===
  #__gene_table($geneClassName, $variantClassName, {'mode' : $xcontext.action, 'defaultProperties' : ['cdna', 'transcript', 'interpretation', 'zygosity'], 'inputStrings' : ['cdna', 'protein','transcript','dbsnp']})
#end
{{/velocity}}</content>
    </property>
    <property>
      <extensionPointId>org.phenotips.patientSheet.section.genotype</extensionPointId>
    </property>
    <property>
      <name>org.phenotips.patientSheet.field.gene-variants</name>
    </property>
    <property>
      <parameters>title=$services.localization.render('phenotips.UIXField.geneVariants')
enabled=true
required=
order=2
fields=genes
pt_class=PhenoTips.GeneClass</parameters>
    </property>
    <property>
      <scope>wiki</scope>
    </property>
  </object>
</xwikidoc>
