<?xml version="1.0" encoding="UTF-8"?>
<!--
 * This file is subject to the terms and conditions defined in file LICENSE,
 * which is part of this source code package.
 *
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>UIX_Field__genetic-reports</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1469213869000</creationDate>
  <parent>PhenoTips.PatientSheet</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1473284545000</date>
  <contentUpdateDate>1471300353000</contentUpdateDate>
  <version>1.1</version>
  <title>$services.localization.render('phenotips.UIXField.genetic-reports')</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content/>
  <object>
    <name>PhenoTips.UIX_Field__genetic-reports</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>77a41042-32bc-4a3d-bae9-2ad1ffba5476</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>var GeneticReportData = (function (GeneticReportData) {
  var tools = GeneticReportData.tools = GeneticReportData.tools || {};
  tools.Editor = Class.create({
    initialize : function () {
      $$('a.delete-genetic-report').invoke('observe', 'click', this.ajaxDeleteData.bindAsEventListener(this));
      $$('a.add-genetic-report').invoke('observe', 'click', this.ajaxAddData.bindAsEventListener(this));
      $$('tr.evaluation_type').invoke('observe', 'change', this.handleDisplayGeneticEvaluationType.bindAsEventListener(this));
    },
    handleDisplayGeneticEvaluationType: function (event) {
      event.stop();
      var trigger = event.element();
      if (trigger.disabled) {
        return;
      }

      // Retrieve options
      var options = [];
      if ($$("tr.evaluation_type")[0]) {
        var optionElements = $$("tr.evaluation_type")[0].select('option');
        for (i = 0; i &lt; optionElements.size(); i++) {
          if (optionElements[i]) {
            options.push(optionElements[i].value); 
          }
        }
      }

      // Hide all
      var geneticReport = trigger.up('tbody');
      for (i = 0; i &lt; options.size(); i++) {
      	if (options[i]) {
	        var propertyElements = geneticReport.select('tr.' + options[i]);
	        if (propertyElements.size() &gt; 0 &amp;&amp; !propertyElements[0].hasClassName('hidden')) {
	          propertyElements[0].addClassName('hidden'); 
	        }
	      }
      }

      // Show selected
      var hiddenProperty = geneticReport.select('tr.' + trigger.value + '.hidden')[0];
      if (trigger.value &amp;&amp; hiddenProperty) {
        hiddenProperty.removeClassName('hidden');
      }
    },
    ajaxDeleteData : function (event) {
      event.stop();
      var deleteTrigger = event.element();
      if (deleteTrigger.disabled) {
        return;
      }
      new XWiki.widgets.ConfirmedAjaxRequest(deleteTrigger.href, {
        onCreate : function() {
          deleteTrigger.disabled = true
        },
        onSuccess : function() {
          var reportsTable = deleteTrigger.up('table.genetic-reports.extradata-list');
          var singleReport = deleteTrigger.up('tr:not(.head-group)');
          if (singleReport) {
            singleReport.remove();
            Event.fire(reportsTable, 'extradata:deleted', {'element' : singleReport});
          }
          if (reportsTable) {
            var i = 1;
            reportsTable.select('th.row-count').each(function(item) {
              item.update(i++);
            });
          }
        },
        onComplete : function() {
          deleteTrigger.disabled = false;
        }
      },
      {
         confirmationText : "Are you sure you want to delete this row?"
      });
    }, 
    ajaxAddData : function (event) {
      event.stop();
      var addTrigger = event.element();
      if (addTrigger.disabled) {
         return;
      }
      var classname = 'PhenoTips.GeneticReportClass'; 
      var dataTable = addTrigger.up('.list-actions').previous('table[id^="extradata-list-' + classname + '"]');
      if (!dataTable) {
        new XWiki.widgets.Notification("Cannot find the list to update" + ' ' + classname, 'error');
      }
      var propertyName = addTrigger.href.replace(/.*&amp;xredirect=.*propertyName=([^&amp;]*).*/, '$1') || '';
      var propertyValue = addTrigger.href.replace(/.*&amp;xredirect=.*propertyValue=([^&amp;]*).*/, '$1') || '';
      var addedDisplaySheet = addTrigger.href.replace(/.*&amp;xredirect=.*addedDisplaySheet=([^&amp;]*).*/, '$1') || '';
      var url = addTrigger.href.replace(/(&amp;xredirect=[^&amp;]*)/m, '$1' + encodeURIComponent('?xpage=plain&amp;xaction=lastreportentry&amp;dataClassName=' + classname + '&amp;withLabel=' + dataTable.hasClassName('withLabel') + '&amp;propertyName=' + propertyName + '&amp;propertyValue=' + propertyValue + (addedDisplaySheet ? '&amp;sheet=' + addedDisplaySheet : ''))).replace(/#.*/m, '');
      new Ajax.Request(url, {
        onCreate : function() {
          addTrigger.disabled = true
          addTrigger._x_notif = new XWiki.widgets.Notification('Adding...', 'inprogress');
        },
        onSuccess : function (response) {
          addTrigger._x_notif.hide();

          var idx = 0;
          var newRow = new Element('tr', {'class' : 'new'});
          var innerEl = new Element('td'); 
          var innerTable = new Element('table');
          var innerTableBody = new Element('tbody');
          
          newRow.insert(innerEl.insert(innerTable.insert(innerTableBody)));
          dataTable.down('tbody').insert(newRow);
         
          if (dataTable.hasClassName('withCounter')) {
            idx = dataTable.select('.row-count').size() + 1;
            newRow.addClassName('genetic-report ' + idx);
          }

          innerTableBody.insert(response.responseText);
          innerTableBody.select('.row-count')[0].update(idx);
          innerTableBody.down('a.delete-genetic-report').observe('click', this.ajaxDeleteData.bindAsEventListener(this));
          innerTableBody.down('tr.evaluation_type').observe('change', this.handleDisplayGeneticEvaluationType.bindAsEventListener(this));

          Event.fire(dataTable, 'extradata:added', {'element' : newRow});
          Event.fire(document, 'xwiki:dom:updated', {'elements' : [newRow]});
        }.bind(this),
        onFailure : function(response) {
          var failureReason = response.statusText;
          if (response.statusText == '' /* No response */ || response.status == 12031 /* In IE */) {
            failureReason = 'Server not responding';
          }
          if (addTrigger._x_notif) {
            addTrigger._x_notif.replace(new XWiki.widgets.Notification("Failed: " + failureReason, "error"));
          } else {
            new XWiki.widgets.Notification(this.interactionParameters.failureMessageText + failureReason, "error");
          }
        },
        on1223 : function(response) {
          response.request.options.onSuccess(response);
        },
        on0 : function(response) {
          response.request.options.onFailure(response);
        },
        onComplete : function() {
          addTrigger.disabled = false
        }
      });
    }
  });
  return GeneticReportData;
}(GeneticReportData || {}));

document.observe('xwiki:dom:loaded', function() {
  new GeneticReportData.tools.Editor();
})
</code>
    </property>
    <property>
      <name>Genetic report event listeners</name>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>currentPage</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.UIX_Field__genetic-reports</name>
    <number>1</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>8e36d87e-9a33-445f-9e85-17f7bb082416</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>var ExtraInputListData = (function (ExtraInputListData) {
  var tools = ExtraInputListData.tools = ExtraInputListData.tools || {};
  tools.Editor = Class.create({
    initialize : function (element) {
    	this.element = element;
    	if (this.element.hasClassName('hasOtherOption')) {
    		this._modifiedSelectListEl = this.element;
    		this._modifiedSelectListEl.observe("change", this._handleSelectDisplay.bindAsEventListener(this));

    	} else if (this.element.hasClassName('otherOption.selectList')) {
    		this._extraInputSelectListEl = this.element;
    		this._extraInputSelectListEl.observe("change", this._handleSelectSave.bindAsEventListener(this));

    	} else if (this.element.hasClassName('otherOption.radioList')) {
    		this._extraInputRadioListEl = this.element;
    		this._extraInputRadioListEl.observe("focus", this._handleRadioClick.bindAsEventListener(this));
    		this._extraInputRadioListEl.observe("blur", this._handleRadioSave.bindAsEventListener(this));
    	}

      this.element.__extraInputField = this;
    },
    _handleSelectDisplay: function(event) {
    	event.stop();
    	var trigger = event.element();
    	if (trigger.disabled) {
    		return;
    	}
    	var selectedOption = trigger.down('option:selected');
    	if (selectedOption &amp;&amp; trigger.up('td') &amp;&amp; trigger.up('td').down('input')) {
    		var extraInput = trigger.up('td').down('input'); 
    		if (selectedOption.hasClassName('addOtherOption')) {
    			extraInput.setAttribute('type', 'text');
    			extraInput.setAttribute('value', '');
    		} else if (selectedOption.hasClassName('otherOption')) {
    	  	extraInput.setAttribute('type', 'text');
    		} else {
    	  	extraInput.setAttribute('type', 'hidden');
    		}
    	}
    },
    _handleSelectSave: function(event) {
    	event.stop();
    	var extraInputTrigger = event.element();
    	if (extraInputTrigger.disabled) {
    		return;
    	}
    	var select = extraInputTrigger.previous();
			if (select &amp;&amp; select.name == extraInputTrigger.name &amp;&amp; select.hasClassName('hasOtherOption')) {
    		select.setAttribute('name', '');
    	}
    },
    _handleRadioClick: function(event) {
    	event.stop();
    	var trigger = event.element();
    	if (trigger.disabled) {
    		return;
    	}
    	var radioOption = trigger.up('label').down('input.addOtherOption');
    	if (!radioOption.checked) {
    		radioOption.checked = true; 
    	}
    },
    _handleRadioSave: function(event) {
    	event.stop();
    	var trigger = event.element();
    	if (trigger.disabled) {
    		return;
    	}
    	var radioOption = trigger.up('label').down('input.addOtherOption');
    	var extraInput = trigger.up('label').down('input.otherOption');
    	if (extraInput.value != '') {
      	radioOption.value = extraInput.value;
    	} else if (extraInput.value == '') {
    		radioOption.value = 'other';
    	}
    }
  });

  var init = function(event) {
  	((event &amp;&amp; event.memo.elements) || [$('body')]).each(function(element) {
   		element.select('select.hasOtherOption').each(function(item) {
  			if (!item.__extraInputField) {
  				item.__extraInputField = new ExtraInputListData.tools.Editor(item);
  			}
  		});
  		element.select('input.otherOption.selectList').each(function(item) {
  			if (!item.__extraInputField) {
  				item.__extraInputField = new ExtraInputListData.tools.Editor(item);
  			}
  		});
  		element.select('input.otherOption.radioList').each(function(item) {
  			if (!item.__extraInputField) {
  				item.__extraInputField = new ExtraInputListData.tools.Editor(item);
  			}
  		});
  	});
  	return true;
  };

  (XWiki.domIsLoaded &amp;&amp; init()) || document.observe("xwiki:dom:loaded", init);
  document.observe("xwiki:dom:updated", init);

  return ExtraInputListData;
}(ExtraInputListData || {}));
</code>
    </property>
    <property>
      <name>Extra "other" input event listeners</name>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>currentPage</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.UIX_Field__genetic-reports</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>93c41b27-8ab1-45ae-94ab-e5303d94568e</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>tr.genetic-report table {
  width: 90%;
  vertical-align: top;
  margin-left: 3em;
  margin-right: 3em;
  margin-top: 0em;
  margin-bottom: 0em;
}

tr.genetic-report table tr.head-group {
	background: #E8E8E8;
}

tr.genetic-report table tr.head-group td.actions a.action {
	text-align: center;
}

tr.property {
  padding: 10px; 
}

.genetic-report .attachment-item label {
  white-space: normal;
}

.genetic-report tr.property input.otherOption.selectList {
  position: relative; 
  max-width: 80%;
  margin: 11px;
}

.genetic-report tr.property input.otherOption.radioList {
  margin: 0px;
}

.genetic-report .xwiki-form-listclass.hasOtherOption.radioList {
  padding: 1px 1px 1px 10px;
}</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>currentPage</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.UIX_Field__genetic-reports</name>
    <number>0</number>
    <className>XWiki.UIExtensionClass</className>
    <guid>5a796ecb-899c-4079-a1b1-1ef0c6f7d701</guid>
    <class>
      <name>XWiki.UIExtensionClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <content>
        <disabled>0</disabled>
        <name>content</name>
        <number>3</number>
        <prettyName>Extension Content</prettyName>
        <rows>10</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </content>
      <extensionPointId>
        <disabled>0</disabled>
        <name>extensionPointId</name>
        <number>1</number>
        <prettyName>Extension Point ID</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </extensionPointId>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Extension ID</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parameters>
        <disabled>0</disabled>
        <name>parameters</name>
        <number>4</number>
        <prettyName>Extension Parameters</prettyName>
        <rows>10</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </parameters>
      <scope>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>scope</name>
        <number>5</number>
        <prettyName>Extension Scope</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>wiki=Current Wiki|user=Current User|global=Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </scope>
    </class>
    <property>
      <content>{{include reference="PhenoTips.GeneticEvaluationMacros" /}}

{{include reference="PhenoTips.TabelarDataMacros" /}}

{{velocity}}
$xwiki.ssx.use('PhenoTips.TabelarDataMacros')##
$xwiki.ssx.use('PhenoTips.UIX_Field__genetic-reports')##
$xwiki.jsx.use('PhenoTips.UIX_Field__genetic-reports')##
#set ($targetClass = $xwiki.getDocument('PhenoTips.GeneticReportClass').xWikiClass)
#set ($targetClassName = 'PhenoTips.GeneticReportClass')
#if ($xcontext.action == 'edit' || $doc.getObject($targetClassName))
=== $services.localization.render('phenotips.UIXField.genetic-reports') ===
#__geneticReports_displayCompact($targetClassName, {'counter' : true, 'labels' : true, 'mode' : $xcontext.action, 'propertyName' : 'other_props'})
#end
{{/velocity}}</content>
    </property>
    <property>
      <extensionPointId>org.phenotips.patientSheet.section.genotype</extensionPointId>
    </property>
    <property>
      <name>org.phenotips.patientSheet.field.genetic-reports</name>
    </property>
    <property>
      <parameters>title=$services.localization.render('phenotips.UIXField.genetic-reports')
enabled=true
required=
order=1
fields=</parameters>
    </property>
    <property>
      <scope>wiki</scope>
    </property>
  </object>
</xwikidoc>
