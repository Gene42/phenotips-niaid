<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc>
  <web>PhenoTips</web>
  <name>AgeSlider</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>PhenoTips.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1359078966000</creationDate>
  <date>1359482961000</date>
  <contentUpdateDate>1359412085000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <object>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>PhenoTips.AgeSlider</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>aa6d0bb5-6fd6-459f-b97e-961d92d733e1</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>document.observe('xwiki:dom:loaded', function () {
  // =====================================================================
  // Time units
  var YEAR_LENGTH = 365;
  var AVG_MONTH_LENGTH = 30.5;
  var WEEK_LENGTH = 7;

  var UNIT_LENGTH = { 
      y : YEAR_LENGTH, 
      m : AVG_MONTH_LENGTH,
      w : WEEK_LENGTH,
      d : 1
  };
  // =====================================================================
  // Formatting the age string
  var formatAge = function(value) {
    if (value == 0) {
      return "Congenital";
    }
    var result = '';
    var y = Math.floor((value + AVG_MONTH_LENGTH/2) / YEAR_LENGTH);
    result = y ? y + 'y' : '';
    var m = Math.round((value - y * YEAR_LENGTH) / AVG_MONTH_LENGTH);
    if (y == 0 &amp;&amp; m &lt; 2) {
      var w = Math.round(value / WEEK_LENGTH);
    } else {
      result += m&gt;0 ? m + 'm' : '';
    }
    if (y == 0 &amp;&amp; m &lt; 2 &amp;&amp; w &lt; 2) {
      var d = Math.round(value);
      w = 0;
    }
    result += w ? w + 'w' : '';
    result += d ? d + 'd' : '';
      
    return result;
  }
  // =====================================================================
  // Parsing the age string
  var parseAge = function(text) {
    if (text == 'Congenital') {
      return 0;
    }
    var result = 0;
    var units = text.split(/[0-9]+/);
    units.shift();
    var values = text.split(/[a-zA-Z]+/);
    values.pop();
    if (units.length == values.length) {
      for (var i = 0; i &lt; values.length; ++i) {
         result += values[i] * (UNIT_LENGTH[units[i]] || 0);
      }
    }      
    return result;
  }
  // =====================================================================
  // Track labels
  var generateLabel = function(value, width) {
     return new Element('span', {'class' : 'slider-track-label'}).setStyle({width:width}).update(formatAge(value));
  };
  var generateLabels = function(track, count, endString) {
     var labels = [];
     var timeIntervalSize = (track._max - track._min)/count;
     var totalWidth = ((count+1) * 100 /count) + '%';
     var labelWidth = (100 /(count+1)) + '%';
     var margin = (-50 / count) + '%';

     minLabel = generateLabel(track._min, labelWidth);
     maxLabel = generateLabel(track._max, labelWidth).insert(endString || '');

     labels.push(minLabel);
     for (var i = 1; i &lt; count; ++i) {
       labels.push(generateLabel(track._min + i * timeIntervalSize, labelWidth));
     }
     var labelsContainer = track.down('.slider-track-labels');
     if (labelsContainer) {
       labelsContainer.update('');
     } else {
       labelsContainer = new Element('span', {'class' : 'slider-track-labels'}).setStyle({
          'width' : totalWidth,
          'margin': '0 ' + margin
       });
       track.insert(labelsContainer);
     }
     labels.push(maxLabel);
     labels.each(function(label) {
       labelsContainer.insert(label);
     });
  };
  
  // =====================================================================
  // Initialize the age track

  var initializeTrack = function(item) {
    //----------------------------------------------------------------------
    // Generate slider(s)
    var sliderContainer = new Element('div', {'class' : 'slider-container'});
    var ageTrack = new Element('div', {'class' : 'slider-track general-track'});
    var ageRange = new Element('div', {'class' : 'slider-range'});
    var ageHandle = new Element('div', {'class' : 'slider-handle'});
    ageTrack.insert(ageRange).insert(ageHandle);
    var precisionTrack = new Element('div', {'class' : 'slider-track precision-track'});
    var precisionHandle = new Element('div', {'class' : 'slider-handle'});
    var precisionArrow = new Element('div', {'class' : 'slider-arrow'});
    precisionTrack.insert(precisionHandle).insert(precisionArrow);
    sliderContainer.insert(ageTrack).insert(precisionTrack);
    var targetInput = item.down('input');
    item.insert({top: new Element('span').update('→')});
    item.insert({top: sliderContainer});
    targetInput.disabled = 'disabled';

    var clearTool = new Element('span', {'class' : 'clear-tool', 'title' : 'Clear'}).update('✖');
    clearTool.observe('click', function(event) {
      targetInput.value = '-';
      clearTool.hide();
      ageHandle.hide();
    });
    targetInput.insert({after : clearTool});

    //----------------------------------------------------------------------
    // Initialize interval track (active on mousemove)
    ageTrack._min = 0;
    ageTrack._max = 7300; // todo: get age from form

    ageRange._width = ageTrack.getWidth() * YEAR_LENGTH / (ageTrack._max - ageTrack._min);
    ageRange.setStyle({'width' : ageRange._width + 'px'});
    generateLabels(ageTrack, 5, '+');

    ageTrack.observe('mousemove', function(event) {
     var t = event.findElement('.general-track');
     var r = t.down('.slider-range');
     var p = t.next('.precision-track');
     var h = p.down('.slider-handle');
     var a = p.down('.slider-arrow');

     var x_start = Math.max(0, Math.min(t.getWidth() - r._width, event.pointerX() - t.viewportOffset().left - r.getWidth()/2));
     var x_mid = x_start + r._width/2;
     r.style.left = x_start + 'px';

     var scale = (t._max - t._min) / t.getWidth();
     p._min = Math.min(Math.max(t._min, x_start * scale), t._max - YEAR_LENGTH);
     p._max = p._min + YEAR_LENGTH;
     t.title = formatAge(p._min) + ' - ' + formatAge(p._max);
     var w = p.getWidth();
     var precisionTrack_left = Math.max(0, Math.min(x_mid - w/2, t.getWidth() - w));
     p._shift = YEAR_LENGTH / 2;
     p.style.left = precisionTrack_left + 'px';
     a.style.left = (x_start - precisionTrack_left) + 'px';
     generateLabels(p, 2);
     if (t._value &gt;= p._min &amp;&amp; t._value &lt;= p._max) {
       h.show();
       h.style.left = (t._value - p._min) * w / (p._max - p._min) + 'px';
     } else {
       h.hide();
     }

    });

    ageTrack._slider = new Control.Slider(ageTrack.down('.slider-handle'), ageTrack, {
      range: $R(ageTrack._min, ageTrack._max),
      sliderValue: 0,
      disabled: true
    });

    //----------------------------------------------------------------------
    // Initialize the precision track (active on drag)
    precisionTrack.observe('mousemove', function(event) {
     var p = event.findElement('.precision-track');
     var scale = (p._max - p._min) / p.getWidth();
     var x = event.pointerX() - p.viewportOffset().left;
     p.title = formatAge(p._min + p._shift + x);
    });

    precisionTrack._slider = new Control.Slider(precisionTrack.down('.slider-handle'), precisionTrack, {
      range: $R(-YEAR_LENGTH/2, YEAR_LENGTH/2),
      sliderValue: 0,
      onSlide: function(value) {
        targetInput.value = formatAge(precisionTrack._min + precisionTrack._shift + value);// + " ? " + Math.round(value);
      },
      onChange: function(value) {
        var realValue = precisionTrack._min + precisionTrack._shift + value;
        ageTrack._value = realValue;
        targetInput.value = formatAge(realValue);
        ageTrack._slider.setValue(realValue);
        ageHandle.show();
        precisionHandle.show();
        clearTool.show();
      }
    });
    //----------------------------------------------------------------------
    // Update the slider to the preset value
    if (targetInput.value == '' || targetInput.value == '-') {
      clearTool.hide();
      ageHandle.hide();
    } else {
      var age = parseAge(targetInput.value);
      ageTrack._slider.setValue(age);
    }
    //----------------------------------------------------------------------
    // Mark as initialized
    item.addClassName('initialized');
  };

  $$('.phenotype-details:not(.initialized) .onset').each(initializeTrack);
  document.observe('xwiki:dom:updated', function (event) {
    if (event.memo &amp;&amp; event.memo.elements) {
      elements.each(function(elt) {
        if (elt.parentNode.hasClassName('phenotype-details') &amp;&amp; elt.down('dd.onset')) {
           initializeTrack(elt.down('dd.onset'));
        }
      });
    }
  })
});</code>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>always</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>PhenoTips.AgeSlider</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>278101bf-7d93-4211-b94e-36d8805e9d0d</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>.phenotype-details .onset &gt; * {
  display: inline-block;
  vertical-align: middle;
  margin: 10px 0;
  line-height: 1.4em;
}
.phenotype-details .onset input {
  background: transparent;
  border: 0 none;
  box-shadow: none;
  color: #333;
  width: 6em;
}
.phenotype-details .onset .clear-tool {
  cursor: pointer;
}
.slider-container {
    position: relative;
    margin: 1em 2em .2em !important;
}
.slider-track { 
  border-radius: 3px;
  height: 20px;
  margin: 10px 0;
  position: relative;
  width: 256px;
}
.slider-track .slider-handle {
  background-color: #a00;
  border-radius: 1px;
  cursor: pointer;
  height: 20px;
  width: 2px;
  position: absolute;
}
.slider-track .slider-range {
  background-color: transparent;
  border: 1px solid #333;
  border-radius: 3px;
  height: 20px;
  position: absolute;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  visibility: hidden;
}
.slider-track:hover .slider-range {
  visibility: visible;
}

.general-track {
  background-color: #f9f9f9;
  box-shadow: 1px 2px 5px #ccc inset;
}

.slider-container:hover .general-track .slider-range {
  visibility: visible;
}
.precision-track {
  background-color: #e9e9e9;
  border: 1px solid #333;
  border-radius: 0 0 3px 3px;
  margin: 0;
  width: 128px;
  height: 32px;
  position: absolute;
  visibility: hidden;
  z-index: 1;
  box-shadow: 0 0 2px #FFF;
}
.slider-container:hover .precision-track {
  visibility: visible;
}
.precision-track .slider-handle {
  background-color: #a00;
  width: 4px;
  height: 32px;
  cursor: pointer;
}
.precision-track .slider-arrow {
  position:absolute;
  top: -11px;
  margin: 0 -1px;
  height: 0;
  border-top: 0 none;
  border-bottom: 11px solid #333;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}
.precision-track .slider-arrow:after {
  content: "";
  display: block;
  position:absolute;
  top: 1px;
  left: -6px;
  height: 0;
  border-top: 0 none;
  border-bottom: 11px solid #e9e9e9;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}
.slider-track-labels {
  display: block;
  color: #aaa;
  position: relative;
}
.slider-track-label {
  display: inline-block;
  font-size: .875em;
  height: 1.4em;
  text-align: center;
  text-shadow: 0 1px 1px #fff;
}
.general-track .slider-track-labels {
  top: -1.4em;
}
.precision-track .slider-track-labels {
  top: 33px;
  background-color: rgba(255,255,255,.9);
  box-shadow: 0 0 2px #FFF;
  color: #333;
}</code>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>always</use>
    </property>
  </object>
  <content>{{velocity}}
$xwiki.jsfx.use('js/scriptaculous/controls.js')##
$xwiki.jsfx.use('js/scriptaculous/slider.js')##
$xwiki.jsx.use('PhenoTips.AgeSlider', {'minify' : false})##
{{/velocity}}

{{html}}
&lt;div class="phenotype-details"&gt;&lt;div class="onset"&gt;&lt;input type="text" id="result"/&gt;&lt;/div&gt;&lt;/div&gt;
{{/html}}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin a lacinia lorem. Fusce erat lectus, aliquam nec ornare vel, rutrum quis sem. Cras dapibus odio ut neque pharetra laoreet. Proin consectetur ultricies commodo. Cras placerat, ipsum at rhoncus aliquet, massa enim sagittis turpis, in luctus ante mi ac nunc. Cras et varius sapien. Proin facilisis accumsan nisl eu porta. Pellentesque velit velit, consectetur vitae pretium fermentum, ultricies quis lacus. Aenean elementum elementum augue, sagittis feugiat enim mollis a. Curabitur eget tellus diam, nec varius mi.

Maecenas sed congue tortor. Aliquam nec sapien diam, sit amet faucibus ipsum. Proin malesuada orci ut sapien ullamcorper congue. Phasellus et arcu vitae metus lacinia ultricies. Donec tincidunt scelerisque nisl quis cursus. Vestibulum ut ultricies ante. Aenean eget sapien neque, sit amet ultrices erat. Vivamus varius est at quam rutrum vehicula.

Pellentesque consequat placerat odio, nec tristique nisl gravida non. Aliquam sed lacus lacus, vel euismod mauris. Vivamus nec sagittis tortor. Nullam vel diam tellus, nec sodales felis. Phasellus nibh lacus, porttitor sit amet ultricies in, tempus et nunc. Praesent elementum porta erat. Cras scelerisque est adipiscing libero consectetur nec rhoncus odio vulputate. Sed rutrum, nisi id elementum blandit, mauris est cursus dolor, nec ultrices nulla lectus et erat.

Duis purus lacus, mattis sed hendrerit eu, vulputate ac magna. Vestibulum id orci id ante eleifend luctus ac sed tortor. Nam imperdiet, est ac ultrices dignissim, ante ligula elementum nisi, non volutpat risus turpis a orci. Mauris blandit porttitor urna, ut porttitor tortor malesuada nec. Aenean est augue, ultrices ut tempus nec, luctus ut lacus. Aenean ac aliquam odio. In hac habitasse platea dictumst. Donec a erat eu lectus dapibus mollis cursus ut magna. Integer velit ipsum, vehicula vitae dictum ut, varius sed sapien. Cras tempus accumsan sapien sed condimentum. Cras mollis fermentum lectus, consectetur pretium dui luctus sit amet.

Sed ultricies, nisi id placerat egestas, lorem velit scelerisque risus, id tempor orci neque eu dolor. Etiam sed porttitor lorem. Nullam facilisis nunc neque. Curabitur tristique vestibulum diam quis aliquam. Donec ultricies, enim fringilla scelerisque feugiat, risus nisl tincidunt magna, quis dictum nibh enim nec purus. Morbi imperdiet euismod metus, quis consectetur tellus aliquet vitae. Praesent non diam turpis, a ornare ligula. Sed ac neque lorem. Aliquam eu tellus magna. Nulla facilisi. 
</content>
</xwikidoc>
